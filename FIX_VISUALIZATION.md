# TextBlockå®šä½é—®é¢˜ä¿®å¤ - å¯è§†åŒ–è¯´æ˜

## é—®é¢˜å¯è§†åŒ–

### ä¿®å¤å‰çš„é—®é¢˜

æƒ³è±¡ä¸€ä¸ª800x600çš„çª—å£ï¼ŒåŒ…å«ä»¥ä¸‹UIå…ƒç´ ï¼š

```
çª—å£ (800x600)
â”œâ”€â”€ StackPanel
    â”œâ”€â”€ TextBlock 1: "Hello, F K UI!" (åº”è¯¥åœ¨ 20, 20)
    â”œâ”€â”€ TextBlock 2: "This is a simple example..." (åº”è¯¥åœ¨ 20, 78.4)
    â””â”€â”€ Button (åº”è¯¥åœ¨ 0, 117.6)
        â””â”€â”€ TextBlock 3: "Click Me" (åº”è¯¥åœ¨ 11, 123.6)
```

**ä¿®å¤å‰çš„æ¸²æŸ“ç»“æœ**ï¼š
```
æ‰€æœ‰TextBlockéƒ½å †åœ¨(0, 0)ï¼

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” (800, 0)
â”‚ Hello, F K UI!                      â”‚
â”‚ This is a simple example...         â”‚
â”‚ Click Me                            â”‚  â† æ‰€æœ‰æ–‡æœ¬é‡å åœ¨è¿™é‡Œï¼
â”‚                                     â”‚
â”‚                                     â”‚
â”‚                                     â”‚
â”‚                                     â”‚
â”‚                                     â”‚
â”‚                                     â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
(0, 600)
```

### ä¿®å¤åçš„æ­£ç¡®ç»“æœ

**ä¿®å¤åçš„æ¸²æŸ“ç»“æœ**ï¼š
```
æ¯ä¸ªTextBlockéƒ½åœ¨æ­£ç¡®ä½ç½®ï¼

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” (800, 0)
â”‚    Hello, F K UI!         (20, 20)  â”‚  âœ“
â”‚                                     â”‚
â”‚    This is a simple example...      â”‚  âœ“ (20, 78.4)
â”‚                           (20,78.4) â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚   â”‚  Click Me  â”‚         (11,123.6) â”‚  âœ“
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                     â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
(0, 600)
```

## ä»£ç ä¿®å¤å¯¹æ¯”

### é—®é¢˜ä»£ç ï¼ˆGlRenderer.cpp ç¬¬562è¡Œå’Œ578è¡Œï¼‰

```cpp
void GlRenderer::DrawText(const TextPayload& payload) {
    ...
    // æ¸²æŸ“æ¯ä¸€è¡Œ
    float lineHeight = payload.fontSize * 1.2f;
    float y = 0.0f;  // âŒ é—®é¢˜ï¼šæ€»æ˜¯ä»0å¼€å§‹
    
    for (const auto& line : lines) {
        ...
        float x = 0.0f;  // âŒ é—®é¢˜ï¼šæ€»æ˜¯ä»0å¼€å§‹
        ...
        
        for (char32_t c : utf32Text) {
            ...
            float xpos = x + glyph->bearingX;  // xpos = 0 + bearing
            float ypos = y + ...;              // ypos = 0 + ...
            
            // ç»“æœï¼šæ‰€æœ‰æ–‡æœ¬éƒ½ä»(0,0)å¼€å§‹æ¸²æŸ“ï¼
        }
    }
}
```

### ä¿®å¤åçš„ä»£ç 

```cpp
void GlRenderer::DrawText(const TextPayload& payload) {
    ...
    // æ¸²æŸ“æ¯ä¸€è¡Œ
    float lineHeight = payload.fontSize * 1.2f;
    float y = payload.bounds.y;  // âœ… ä¿®å¤ï¼šä½¿ç”¨å…¨å±€Yåæ ‡
    
    for (const auto& line : lines) {
        ...
        float x = payload.bounds.x;  // âœ… ä¿®å¤ï¼šä½¿ç”¨å…¨å±€Xåæ ‡
        ...
        
        for (char32_t c : utf32Text) {
            ...
            float xpos = x + glyph->bearingX;  // xpos = 20 + bearing
            float ypos = y + ...;              // ypos = 20 + ...
            
            // ç»“æœï¼šæ–‡æœ¬ä»æ­£ç¡®çš„ä½ç½®å¼€å§‹æ¸²æŸ“ï¼
        }
    }
}
```

## åæ ‡å˜æ¢æµç¨‹

### å®Œæ•´çš„åæ ‡å˜æ¢é“¾

```
1. TextBlockåˆ›å»ºæ—¶ï¼š
   layoutRect = (20, 20, width, height)  // ç”±å¸ƒå±€ç³»ç»Ÿè®¡ç®—

2. UIElement::CollectDrawCommandsï¼š
   context.PushTransform(20, 20);  // æ¨å…¥å˜æ¢
   â†“
   currentTransform = {offsetX: 20, offsetY: 20}

3. TextBlock::OnRenderï¼š
   position = Point(0, 0);  // æœ¬åœ°åæ ‡
   context.DrawText(position, ...)

4. RenderContext::DrawTextï¼š
   globalPos = TransformPoint(position);
   // globalPos = (0 + 20, 0 + 20) = (20, 20)
   â†“
   payload.bounds = Rect{20, 20, 0, 0};

5. GlRenderer::DrawTextï¼š
   ã€ä¿®å¤å‰ã€‘
   float x = 0.0f;  âŒ
   float y = 0.0f;  âŒ
   â†’ æ¸²æŸ“åœ¨(0, 0)
   
   ã€ä¿®å¤åã€‘
   float x = payload.bounds.x;  âœ… = 20
   float y = payload.bounds.y;  âœ… = 20
   â†’ æ¸²æŸ“åœ¨(20, 20)
```

## æµ‹è¯•éªŒè¯ç»“æœ

### åœºæ™¯1ï¼šç®€å•StackPanel

**å¸ƒå±€**ï¼š
```
StackPanel (0, 0)
â”œâ”€â”€ TextBlock "First Text"  â†’ layoutRect(10, 10)
â””â”€â”€ TextBlock "Second Text" â†’ layoutRect(10, 44)
```

**æ¸²æŸ“å‘½ä»¤**ï¼š
```
SetTransform: offset=(10, 10)
DrawText: position=(10, 10) text="First Text"      âœ…

SetTransform: offset=(10, 44)
DrawText: position=(10, 44) text="Second Text"    âœ…
```

### åœºæ™¯2ï¼šButtonå†…çš„TextBlock

**å¸ƒå±€**ï¼š
```
Button(20, 100)
â””â”€â”€ Border(0, 0) padding(11, 6)
    â””â”€â”€ ContentPresenter(11, 6)
        â””â”€â”€ TextBlock(0, 0)
```

**ç´¯ç§¯åæ ‡**ï¼š
- Button: 20, 100
- + Border padding: 11, 6
- = TextBlockå…¨å±€ä½ç½®: 31, 106

**æ¸²æŸ“å‘½ä»¤**ï¼š
```
SetTransform: offset=(31, 106)
DrawText: position=(31, 106) text="Click Me"      âœ…
```

### åœºæ™¯3ï¼šå¤§åç§»æµ‹è¯•

**å¸ƒå±€**ï¼š
```
TextBlock(50, 100)  â†’ DrawText(50, 100)    âœ…
TextBlock(50, 314)  â†’ DrawText(50, 314.4)  âœ…
```

æ‰€æœ‰ä½ç½®éƒ½æ­£ç¡®ï¼æ²¡æœ‰ä»»ä½•TextBlockåœ¨(0, 0)ï¼

## å½±å“å’Œæ•ˆæœ

### ä¿®å¤å‰çš„ç”¨æˆ·ä½“éªŒ
- âŒ æ‰“å¼€example/main.cpp
- âŒ çœ‹åˆ°æ‰€æœ‰æ–‡æœ¬é‡å åœ¨å·¦ä¸Šè§’
- âŒ å®Œå…¨æ— æ³•ä½¿ç”¨UI
- âŒ çœ‹ä¸æ¸…ä»»ä½•å†…å®¹

### ä¿®å¤åçš„ç”¨æˆ·ä½“éªŒ  
- âœ… æ‰“å¼€example/main.cpp
- âœ… çœ‹åˆ°æ ‡é¢˜åœ¨é¡¶éƒ¨
- âœ… å‰¯æ ‡é¢˜åœ¨æ ‡é¢˜ä¸‹æ–¹
- âœ… æŒ‰é’®åœ¨é€‚å½“ä½ç½®ï¼Œæ–‡å­—å±…ä¸­
- âœ… UIå®Œå…¨æ­£å¸¸å·¥ä½œï¼

## æŠ€æœ¯è¦ç‚¹

### ä¸ºä»€ä¹ˆè¿™ä¸ªbugå¾ˆéšè”½ï¼Ÿ

1. **æµ‹è¯•è¦†ç›–ä¸è¶³**ï¼š
   - ä¹‹å‰çš„æµ‹è¯•åªæ£€æŸ¥RenderCommandçš„payload
   - payloadä¸­çš„åæ ‡æ˜¯æ­£ç¡®çš„(20, 20)
   - ä½†æ²¡æœ‰æµ‹è¯•å®é™…çš„æ¸²æŸ“æ‰§è¡Œ

2. **æ¶æ„åˆ†å±‚**ï¼š
   - é—®é¢˜å‡ºåœ¨æœ€åçš„æ¸²æŸ“å±‚ï¼ˆGlRendererï¼‰
   - ä¹‹å‰æ‰€æœ‰å±‚ï¼ˆTextBlock, UIElement, RenderContextï¼‰éƒ½æ­£ç¡®
   - åªæœ‰æœ€åä¸€æ­¥å‡ºé”™äº†

3. **ä»£ç çœ‹èµ·æ¥"æœ‰é“ç†"**ï¼š
   - `float x = 0.0f;` çœ‹èµ·æ¥æ˜¯åˆå§‹åŒ–
   - ä½†å®é™…ä¸Šåº”è¯¥ä»payload.boundså¼€å§‹

### ä¸ºä»€ä¹ˆä¿®å¤è¿™ä¹ˆç®€å•ï¼Ÿ

ä¿®å¤åªéœ€è¦2è¡Œä»£ç çš„åŸå› ï¼š
- âœ… æ‰€æœ‰çš„åæ ‡è®¡ç®—éƒ½å·²ç»å®Œæˆ
- âœ… payload.boundsä¸­å·²ç»æœ‰æ­£ç¡®çš„å…¨å±€åæ ‡
- âœ… åªéœ€è¦ä½¿ç”¨å®ƒè€Œä¸æ˜¯ç¡¬ç¼–ç çš„0

è¿™å°±æ˜¯"æœ€åä¸€å…¬é‡Œ"bugçš„å…¸å‹ç‰¹å¾ï¼

## æ€»ç»“

**é—®é¢˜**ï¼šæ‰€æœ‰TextBlockéƒ½åœ¨(0, 0) âŒ  
**åŸå› **ï¼šGlRendererå¿½ç•¥äº†payload.bounds  
**ä¿®å¤**ï¼šä½¿ç”¨payload.boundsä½œä¸ºèµ·å§‹åæ ‡ âœ…  
**ä»£ç **ï¼š2è¡Œ  
**æ•ˆæœ**ï¼šUIå®Œå…¨æ¢å¤æ­£å¸¸ï¼ ğŸ‰
