# é”®ç›˜äº‹ä»¶å’Œç„¦ç‚¹ç®¡ç†è¯´æ˜

## å®ç°æ¦‚è¿°

æœ¬æ¬¡å®ç°æ·»åŠ äº†å®Œæ•´çš„é”®ç›˜äº‹ä»¶å¤„ç†å’Œç„¦ç‚¹ç®¡ç†åŠŸèƒ½ï¼Œç¡®ä¿é”®ç›˜è¾“å…¥èƒ½å¤Ÿæ­£ç¡®ä¼ é€’åˆ°å…·æœ‰ç„¦ç‚¹çš„ UI å…ƒç´ ã€‚

## 1. ç„¦ç‚¹ç®¡ç†ï¼ˆFocusManagerï¼‰

### åŠŸèƒ½ç‰¹æ€§
- **ç„¦ç‚¹è®¾ç½®**ï¼š`SetFocusedElement(UIElement*)`
- **ç„¦ç‚¹è·å–**ï¼š`GetFocusedElement()`
- **ç„¦ç‚¹æ¸…é™¤**ï¼š`ClearFocus()`
- **ç„¦ç‚¹å¯¼èˆª**ï¼š`MoveFocus(FocusNavigationDirection)` æ”¯æŒ Tabã€æ–¹å‘é”®å¯¼èˆª
- **ç„¦ç‚¹å˜æ›´äº‹ä»¶**ï¼š`FocusChanged` äº‹ä»¶

### ç„¦ç‚¹å¯¼èˆªæ–¹å‘
```cpp
enum class FocusNavigationDirection {
    Next,       // ä¸‹ä¸€ä¸ªï¼ˆTabï¼‰
    Previous,   // ä¸Šä¸€ä¸ªï¼ˆShift+Tabï¼‰
    Up,         // å‘ä¸Šï¼ˆArrow Upï¼‰
    Down,       // å‘ä¸‹ï¼ˆArrow Downï¼‰
    Left,       // å‘å·¦ï¼ˆArrow Leftï¼‰
    Right       // å‘å³ï¼ˆArrow Rightï¼‰
};
```

### é›†æˆæ–¹å¼
åœ¨ Window æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–ï¼š
```cpp
// åˆå§‹åŒ–ç„¦ç‚¹ç®¡ç†å™¨å¹¶è®¾ç½®æ ¹èŠ‚ç‚¹ä¸ºçª—å£æœ¬èº«
focusManager_ = std::make_unique<FocusManager>();
focusManager_->SetRoot(this);
```

## 2. é”®ç›˜äº‹ä»¶å¤„ç†

### GLFW å›è°ƒè®¾ç½®

åœ¨ `Window::Show()` ä¸­è®¾ç½®äº†ä¸¤ä¸ªé”®ç›˜å›è°ƒï¼š

#### 2.1 æŒ‰é”®å›è°ƒï¼ˆglfwSetKeyCallbackï¼‰
å¤„ç†æŒ‰é”®æŒ‰ä¸‹ã€é‡Šæ”¾å’Œé‡å¤äº‹ä»¶ï¼š
```cpp
glfwSetKeyCallback(window, [](GLFWwindow* win, int key, int scancode, int action, int mods) {
    auto* self = static_cast<Window*>(glfwGetWindowUserPointer(win));
    if (!self || !self->inputManager_) return;
    
    PlatformKeyEvent event;
    event.key = key;                    // GLFW é”®ç 
    event.scanCode = scancode;          // æ‰«æç 
    event.isRepeat = (action == GLFW_REPEAT);
    event.ctrlKey = (mods & GLFW_MOD_CONTROL) != 0;
    event.shiftKey = (mods & GLFW_MOD_SHIFT) != 0;
    event.altKey = (mods & GLFW_MOD_ALT) != 0;
    
    if (action == GLFW_PRESS || action == GLFW_REPEAT) {
        event.type = PlatformKeyEvent::Type::Down;
    } else if (action == GLFW_RELEASE) {
        event.type = PlatformKeyEvent::Type::Up;
    }
    
    self->inputManager_->ProcessKeyboardEvent(event);
});
```

#### 2.2 å­—ç¬¦è¾“å…¥å›è°ƒï¼ˆglfwSetCharCallbackï¼‰
å¤„ç† Unicode å­—ç¬¦è¾“å…¥ï¼ˆç”¨äºæ–‡æœ¬æ¡†ç­‰ï¼‰ï¼š
```cpp
glfwSetCharCallback(window, [](GLFWwindow* win, unsigned int codepoint) {
    auto* self = static_cast<Window*>(glfwGetWindowUserPointer(win));
    if (!self || !self->inputManager_) return;
    
    PlatformKeyEvent event;
    event.type = PlatformKeyEvent::Type::Char;
    event.character = static_cast<char32_t>(codepoint);
    
    self->inputManager_->ProcessKeyboardEvent(event);
});
```

### PlatformKeyEvent ç»“æ„
```cpp
struct PlatformKeyEvent {
    enum class Type {
        Down,   // æŒ‰é”®æŒ‰ä¸‹
        Up,     // æŒ‰é”®é‡Šæ”¾
        Char    // å­—ç¬¦è¾“å…¥
    };
    
    Type type{Type::Down};
    int key{0};              // é”®ç ï¼ˆGLFW_KEY_*ï¼‰
    int scanCode{0};         // æ‰«æç 
    char32_t character{0};   // Unicode å­—ç¬¦ï¼ˆç”¨äº Char äº‹ä»¶ï¼‰
    bool isRepeat{false};    // æ˜¯å¦ä¸ºé‡å¤æŒ‰é”®
    bool ctrlKey{false};     // Ctrl ä¿®é¥°é”®
    bool shiftKey{false};    // Shift ä¿®é¥°é”®
    bool altKey{false};      // Alt ä¿®é¥°é”®
};
```

## 3. InputManager ä¸ FocusManager é›†æˆ

### è¿æ¥æœºåˆ¶
```cpp
// Window æ„é€ å‡½æ•°ä¸­
inputManager_ = std::make_unique<InputManager>();
inputManager_->SetRoot(this);
inputManager_->SetFocusManager(focusManager_.get());
```

### é”®ç›˜äº‹ä»¶å¤„ç†æµç¨‹
```cpp
void InputManager::ProcessKeyboardEvent(const PlatformKeyEvent& event) {
    // 1. è·å–å½“å‰ç„¦ç‚¹å…ƒç´ ï¼ˆé€šè¿‡ FocusManagerï¼‰
    UIElement* target = GetFocusedElement();
    
    if (!target) {
        return;  // æ— ç„¦ç‚¹å…ƒç´ ï¼Œä¸å¤„ç†é”®ç›˜äº‹ä»¶
    }
    
    // 2. æ ¹æ®äº‹ä»¶ç±»å‹åˆ†å‘
    switch (event.type) {
        case PlatformKeyEvent::Type::Down:
            DispatchKeyDown(target, event);
            break;
        case PlatformKeyEvent::Type::Up:
            DispatchKeyUp(target, event);
            break;
        case PlatformKeyEvent::Type::Char:
            // TODO: å­—ç¬¦è¾“å…¥äº‹ä»¶
            break;
    }
}
```

### äº‹ä»¶åˆ†å‘
```cpp
void InputManager::DispatchKeyDown(UIElement* target, const PlatformKeyEvent& event) {
    if (!target) return;
    
    KeyEventArgs args(target, event.key, event.isRepeat);
    target->OnKeyDown(args);
}

void InputManager::DispatchKeyUp(UIElement* target, const PlatformKeyEvent& event) {
    if (!target) return;
    
    KeyEventArgs args(target, event.key, event.isRepeat);
    target->OnKeyUp(args);
}
```

## 4. å®Œæ•´äº‹ä»¶æµç¨‹

### é”®ç›˜äº‹ä»¶æµç¨‹
```
ç”¨æˆ·æŒ‰é”®
    â†“
GLFW æ•è·ï¼ˆglfwSetKeyCallback / glfwSetCharCallbackï¼‰
    â†“
è½¬æ¢ä¸º PlatformKeyEvent
    â†“
InputManager::ProcessKeyboardEvent
    â†“
ä» FocusManager è·å–ç„¦ç‚¹å…ƒç´ 
    â†“
DispatchKeyDown / DispatchKeyUp
    â†“
UIElement::OnKeyDown / OnKeyUp
    â†“
å…ƒç´ å¤„ç†é”®ç›˜è¾“å…¥
```

### ç„¦ç‚¹å˜æ›´æµç¨‹
```
ç”¨æˆ·æ“ä½œï¼ˆç‚¹å‡»ã€Tab é”®ç­‰ï¼‰
    â†“
FocusManager::SetFocusedElement(newElement)
    â†“
æ£€æŸ¥å…ƒç´ æ˜¯å¦å¯èšç„¦ï¼ˆFocusable å±æ€§ï¼‰
    â†“
æ›´æ–°å†…éƒ¨ç„¦ç‚¹çŠ¶æ€
    â†“
è§¦å‘ FocusChanged äº‹ä»¶
    â†“
æ—§å…ƒç´ ï¼šOnLostFocus
æ–°å…ƒç´ ï¼šOnGotFocus
```

## 5. UIElement é”®ç›˜äº‹ä»¶å¤„ç†

UIElement æä¾›äº†è™šæ–¹æ³•ä¾›æ´¾ç”Ÿç±»é‡å†™ï¼š

```cpp
class UIElement {
public:
    // é”®ç›˜äº‹ä»¶è™šæ–¹æ³•
    virtual void OnKeyDown(KeyEventArgs& e);
    virtual void OnKeyUp(KeyEventArgs& e);
    virtual void OnGotFocus(FocusEventArgs& e);
    virtual void OnLostFocus(FocusEventArgs& e);
    
    // ç„¦ç‚¹å±æ€§
    bool GetIsFocusable() const;
    void SetIsFocusable(bool value);
    bool GetIsFocused() const;
};
```

## 6. ä½¿ç”¨ç¤ºä¾‹

### è®¾ç½®ç„¦ç‚¹
```cpp
// è·å–ç„¦ç‚¹ç®¡ç†å™¨ï¼ˆé€šå¸¸ä» Window è·å–ï¼‰
auto* focusManager = window->GetFocusManager();

// è®¾ç½®ç„¦ç‚¹åˆ°æŸä¸ªå…ƒç´ 
focusManager->SetFocusedElement(myTextBox);
```

### å¤„ç†é”®ç›˜äº‹ä»¶
```cpp
class MyTextBox : public Control<MyTextBox> {
protected:
    void OnKeyDown(KeyEventArgs& e) override {
        Control<MyTextBox>::OnKeyDown(e);
        
        if (e.key == GLFW_KEY_ENTER) {
            // å¤„ç†å›è½¦é”®
            SubmitText();
            e.handled = true;
        } else if (e.key == GLFW_KEY_ESCAPE) {
            // å¤„ç† ESC é”®
            CancelEdit();
            e.handled = true;
        }
    }
};
```

### ç„¦ç‚¹å¯¼èˆª
```cpp
// Tab é”®å¯¼èˆªåˆ°ä¸‹ä¸€ä¸ªå¯èšç„¦å…ƒç´ 
focusManager->MoveFocus(FocusNavigationDirection::Next);

// æ–¹å‘é”®å¯¼èˆª
focusManager->MoveFocus(FocusNavigationDirection::Down);
```

## 7. æ¶æ„ä¼˜åŠ¿

1. **èŒè´£åˆ†ç¦»**ï¼š
   - FocusManagerï¼šç®¡ç†ç„¦ç‚¹çŠ¶æ€
   - InputManagerï¼šå¤„ç†è¾“å…¥äº‹ä»¶åˆ†å‘
   - UIElementï¼šå“åº”é”®ç›˜äº‹ä»¶

2. **æ¾è€¦åˆ**ï¼š
   - InputManager é€šè¿‡æŒ‡é’ˆå¼•ç”¨ FocusManager
   - ä½¿ç”¨å‰å‘å£°æ˜é¿å…å¤´æ–‡ä»¶å¾ªç¯ä¾èµ–

3. **å¯æ‰©å±•æ€§**ï¼š
   - æ˜“äºæ·»åŠ æ–°çš„ç„¦ç‚¹å¯¼èˆªç­–ç•¥
   - æ”¯æŒè‡ªå®šä¹‰é”®ç›˜äº‹ä»¶å¤„ç†

4. **æ€§èƒ½ä¼˜åŒ–**ï¼š
   - åªæœ‰ç„¦ç‚¹å…ƒç´ æ¥æ”¶é”®ç›˜äº‹ä»¶
   - é¿å…ä¸å¿…è¦çš„äº‹ä»¶éå†

## 8. å·²å®ç°çš„åŠŸèƒ½

- âœ… GLFW é”®ç›˜äº‹ä»¶å›è°ƒè®¾ç½®
- âœ… æŒ‰é”®æŒ‰ä¸‹/é‡Šæ”¾äº‹ä»¶å¤„ç†
- âœ… å­—ç¬¦è¾“å…¥äº‹ä»¶æ”¯æŒ
- âœ… ä¿®é¥°é”®çŠ¶æ€ï¼ˆCtrlã€Shiftã€Altï¼‰
- âœ… é‡å¤æŒ‰é”®æ£€æµ‹
- âœ… FocusManager é›†æˆ
- âœ… ç„¦ç‚¹å…ƒç´ è·å–
- âœ… é”®ç›˜äº‹ä»¶åˆ†å‘åˆ°ç„¦ç‚¹å…ƒç´ 

## 9. å¾…å®Œå–„çš„åŠŸèƒ½

- ğŸ”„ å­—ç¬¦è¾“å…¥äº‹ä»¶çš„å®Œæ•´å¤„ç†ï¼ˆDispatchCharInputï¼‰
- ğŸ”„ ç„¦ç‚¹å¯¼èˆªçš„è‡ªåŠ¨è§¦å‘ï¼ˆTab/Shift+Tab/æ–¹å‘é”®ï¼‰
- ğŸ”„ ç„¦ç‚¹å¯è§†åŒ–æŒ‡ç¤ºå™¨ï¼ˆFocusVisualï¼‰
- ğŸ”„ è¾“å…¥æ³•ç¼–è¾‘å™¨ï¼ˆIMEï¼‰æ”¯æŒ

## 10. æµ‹è¯•å»ºè®®

### åŸºç¡€é”®ç›˜äº‹ä»¶æµ‹è¯•
```cpp
auto textBox = new TextBox();
textBox->SetIsFocusable(true);
focusManager->SetFocusedElement(textBox);

// æµ‹è¯•æŒ‰é”®æ˜¯å¦è¢«æ­£ç¡®æ¥æ”¶
// æµ‹è¯•ä¿®é¥°é”®ç»„åˆï¼ˆCtrl+Cã€Ctrl+V ç­‰ï¼‰
// æµ‹è¯•å­—ç¬¦è¾“å…¥
```

### ç„¦ç‚¹å¯¼èˆªæµ‹è¯•
```cpp
// åˆ›å»ºå¤šä¸ªå¯èšç„¦å…ƒç´ 
auto button1 = new Button();
auto button2 = new Button();
auto textBox = new TextBox();

// æµ‹è¯• Tab é”®å¯¼èˆª
// æµ‹è¯•æ–¹å‘é”®å¯¼èˆª
// æµ‹è¯•ç„¦ç‚¹è¾¹ç•Œå¤„ç†
```

---

**å®ç°æ—¥æœŸ**ï¼š2025-11-17  
**å®ç°è€…**ï¼šGitHub Copilot Agent
