# Development Guide

## Project Structure

```
F__K_UI/
├── include/fk/          # Public header files
│   ├── app/            # Application module (Application, Window)
│   ├── binding/        # Data binding system (DependencyProperty, Binding)
│   ├── core/           # Core utilities (Dispatcher, Event, Logger)
│   ├── render/         # Rendering system (Renderer, RenderBackend)
│   └── ui/             # UI controls and elements
├── src/                # Implementation files
│   ├── app/
│   ├── binding/
│   ├── core/
│   ├── render/
│   └── ui/
├── examples/           # Example applications
├── samples/            # Sample projects
├── third_party/        # Third-party dependencies
│   ├── glfw/          # Window management
│   ├── freetype/      # Font rendering
│   └── stb/           # Image loading (stb_image)
├── Docs/              # Documentation
│   ├── API/           # API reference
│   ├── Designs/       # Architecture and design docs
│   ├── GettingStarted.md
│   ├── Development.md (this file)
│   └── Implementation-Status.md
└── CMakeLists.txt     # Build configuration
```

## Architecture Overview

### Module Hierarchy

```
┌─────────────────────────────────────────┐
│          Application Layer              │
│     (app::Application, Window)          │
└─────────────────┬───────────────────────┘
                  │
┌─────────────────▼───────────────────────┐
│           UI Layer                      │
│  (Controls, Panels, Visual Tree)        │
└─────────────────┬───────────────────────┘
                  │
┌─────────────────▼───────────────────────┐
│        Binding Layer                    │
│  (DependencyObject, Binding System)     │
└─────────────────┬───────────────────────┘
                  │
┌─────────────────▼───────────────────────┐
│        Render Layer                     │
│   (Renderer, RenderBackend, OpenGL)     │
└─────────────────┬───────────────────────┘
                  │
┌─────────────────▼───────────────────────┐
│         Core Layer                      │
│  (Dispatcher, Events, Utilities)        │
└─────────────────────────────────────────┘
```

## Key Components

### 1. Core Module (`core/`)

**Purpose**: Fundamental utilities and infrastructure

**Key Classes**:
- `Dispatcher`: Thread-safe event dispatching
- `DispatcherObject`: Base for thread-affinity objects
- `Event<T>`: Type-safe event system
- `Logger`: Logging infrastructure
- `Clock`: Time management

### 2. Binding Module (`binding/`)

**Purpose**: Dependency property and data binding system

**Key Classes**:
- `DependencyObject`: Base class with dependency properties
- `DependencyProperty`: Property metadata and management
- `Binding`: Data binding configuration
- `BindingExpression`: Active binding connection
- `ObservableObject`: Base for ViewModels with INPC

**Key Features**:
- Property change notification
- Value propagation
- Two-way binding support
- Value converters

### 3. UI Module (`ui/`)

**Purpose**: Visual elements and controls

**Key Classes**:
- `Visual`: Base visual tree node
- `UIElement`: Interactive visual element
- `FrameworkElement`: Layout and sizing support
- `Control`: Templatable control base
- `Panel`: Container for multiple children
- `ContentControl`: Single-content container

**Controls**:
- Layout: `StackPanel`, `Grid`, `Canvas`
- Content: `Button`, `TextBlock`, `TextBox`, `Border`, `Image`
- Collections: `ItemsControl`, `ListBox`, `ScrollViewer`

### 4. Render Module (`render/`)

**Purpose**: Rendering pipeline and graphics

**Key Classes**:
- `IRenderer`: Renderer interface
- `GlRenderer`: OpenGL implementation
- `RenderBackend`: Platform abstraction
- `RenderCommand`: Drawing commands
- `TextRenderer`: Font rendering (FreeType)

### 5. App Module (`app/`)

**Purpose**: Application lifecycle and windowing

**Key Classes**:
- `Application`: Application singleton
- `Window`: Top-level window

## Development Workflow

### Setting Up Development Environment

1. **Install Dependencies**:
   - CMake 3.20+
   - C++17/20 compiler
   - OpenGL 3.3+ drivers

2. **Clone and Build**:
   ```bash
   git clone https://github.com/taigongzhaihua/F__K_UI.git
   cd F__K_UI
   mkdir build && cd build
   cmake ..
   cmake --build . -j8
   ```

3. **IDE Configuration**:
   - Visual Studio: Open `F__K_UI.sln` (generated by CMake)
   - CLion: Open `CMakeLists.txt` as project
   - VS Code: Use CMake Tools extension

### Building the Project

```bash
# Debug build
cmake -DCMAKE_BUILD_TYPE=Debug ..
cmake --build .

# Release build
cmake -DCMAKE_BUILD_TYPE=Release ..
cmake --build .

# Clean build
rm -rf build
mkdir build && cd build
cmake ..
cmake --build .
```

### Code Style

- **Naming**:
  - Classes: `PascalCase`
  - Methods: `PascalCase`
  - Variables: `camelCase`
  - Private members: `m_camelCase`
  - Constants: `UPPER_SNAKE_CASE` or `kPascalCase`

- **Formatting**:
  - Indent: 4 spaces
  - Braces: Same line for functions/classes
  - Max line length: 120 characters

- **Comments**:
  - Use `///` for documentation comments
  - Explain "why", not "what"
  - Document public APIs

### Adding a New Control

1. **Create header** (`include/fk/ui/MyControl.h`):

```cpp
#pragma once
#include "Control.h"

namespace fk::ui {

class MyControl : public Control {
public:
    MyControl();
    virtual ~MyControl() = default;

    // Properties
    static DependencyProperty* MyPropertyProperty;
    void SetMyProperty(const std::string& value);
    std::string GetMyProperty() const;

protected:
    // Override for custom rendering
    virtual void OnRender(render::RenderContext* context) override;
    
    // Override for custom layout
    virtual Size MeasureOverride(const Size& availableSize) override;
    virtual Size ArrangeOverride(const Size& finalSize) override;

private:
    void OnMyPropertyChanged(const std::string& oldValue, const std::string& newValue);
};

} // namespace fk::ui
```

2. **Implement** (`src/ui/MyControl.cpp`):

```cpp
#include "fk/ui/MyControl.h"

namespace fk::ui {

DependencyProperty* MyControl::MyPropertyProperty = 
    DependencyProperty::Register("MyProperty", 
                                 typeid(std::string),
                                 typeid(MyControl),
                                 new PropertyMetadata("default"));

MyControl::MyControl() {
    // Initialize
}

void MyControl::SetMyProperty(const std::string& value) {
    SetValue(MyPropertyProperty, value);
}

std::string MyControl::GetMyProperty() const {
    return GetValue<std::string>(MyPropertyProperty);
}

void MyControl::OnRender(render::RenderContext* context) {
    Control::OnRender(context);
    // Custom rendering
}

Size MyControl::MeasureOverride(const Size& availableSize) {
    // Calculate desired size
    return Size(100, 100);
}

Size MyControl::ArrangeOverride(const Size& finalSize) {
    // Arrange children
    return finalSize;
}

} // namespace fk::ui
```

3. **Update CMakeLists.txt**:

```cmake
set(UI_SOURCES
    # ... existing files ...
    src/ui/MyControl.cpp
)
```

### Adding a Dependency Property

```cpp
// In header
static DependencyProperty* MyPropertyProperty;

// In implementation
DependencyProperty* MyClass::MyPropertyProperty = 
    DependencyProperty::Register(
        "MyProperty",                          // Property name
        typeid(MyPropertyType),                // Property type
        typeid(MyClass),                       // Owner type
        new PropertyMetadata(
            defaultValue,                      // Default value
            [](DependencyObject* d, const DependencyPropertyChangedEventArgs& e) {
                // Property changed callback
                auto obj = static_cast<MyClass*>(d);
                obj->OnMyPropertyChanged(e);
            }
        )
    );
```

### Debugging Tips

1. **Enable Logging**:
   ```cpp
   Logger::SetLogLevel(LogLevel::Debug);
   ```

2. **Visual Tree Inspection**:
   ```cpp
   void PrintVisualTree(Visual* root, int indent = 0) {
       for (int i = 0; i < indent; i++) std::cout << "  ";
       std::cout << typeid(*root).name() << std::endl;
       
       for (int i = 0; i < root->GetVisualChildrenCount(); i++) {
           PrintVisualTree(root->GetVisualChild(i), indent + 1);
       }
   }
   ```

3. **Property Value Debugging**:
   ```cpp
   auto value = element->GetValue(PropertyName);
   std::cout << "Property value: " << value << std::endl;
   ```

## Testing

### Running Examples

```bash
cd build

# Run specific example
./hello_world

# Run all examples
./phase1_enhancement_demo
./button_example
./image_demo
```

### Creating a Test Application

```cpp
#include "fk/app/Application.h"
// ... your test code ...

int main() {
    auto app = app::Application::Create();
    // Test setup
    return app->Run();
}
```

Add to `examples/CMakeLists.txt`:

```cmake
add_executable(my_test my_test.cpp)
target_link_libraries(my_test fk_ui)
```

## Performance Considerations

### Layout Performance

- Minimize nested layouts
- Use cached layout results
- Avoid unnecessary `InvalidateMeasure()`/`InvalidateArrange()` calls

### Rendering Performance

- Batch similar draw calls
- Use texture atlases for images
- Implement dirty region tracking
- Cache render commands when possible

### Memory Management

- Use smart pointers (`std::shared_ptr`, `std::unique_ptr`)
- Clean up event handlers to avoid leaks
- Be careful with circular references in binding

## Contributing

### Pull Request Process

1. Fork the repository
2. Create a feature branch: `git checkout -b feature/my-feature`
3. Make changes and commit: `git commit -am 'Add new feature'`
4. Push to branch: `git push origin feature/my-feature`
5. Open a Pull Request

### Code Review Checklist

- [ ] Code follows style guidelines
- [ ] New APIs are documented
- [ ] Changes don't break existing functionality
- [ ] Examples demonstrate new features
- [ ] Build succeeds without warnings

## Roadmap

See [Implementation-Status.md](Implementation-Status.md) for current progress.

### Phase 2 (In Progress)
- Style system
- Control templates
- Data templates
- Shape graphics

### Phase 3 (Planned)
- Advanced animations
- Resource dictionaries
- Themes
- Triggers

## Resources

- [Architecture Documentation](Designs/Architecture-Refactoring.md)
- [API Reference](API/README.md)
- [WPF Documentation](https://docs.microsoft.com/en-us/dotnet/desktop/wpf/) (Inspiration)

---

**Questions? Open an issue on GitHub!**
